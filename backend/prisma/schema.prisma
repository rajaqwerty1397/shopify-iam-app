// =============================================================================
// PERSONA SSO - Database Schema
// =============================================================================
// PostgreSQL database schema for enterprise SSO solution
// Supports multi-platform (Shopify, WooCommerce) and multi-app architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum PlatformStatus {
  ACTIVE
  INACTIVE
}

enum ApplicationStatus {
  ACTIVE
  INACTIVE
}

enum AppPlatformStatus {
  ACTIVE
  INACTIVE
}

enum StoreStatus {
  active
  paused
  uninstalled
  suspended
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  expired
}

enum BillingCycle {
  monthly
  annual
}

enum SsoProviderStatus {
  active
  disabled
  pending_setup
}

enum SsoProtocol {
  oidc
  saml
}

enum SsoUserStatus {
  active
  blocked
  pending
}

enum LoginEventType {
  login_initiated
  login_success
  login_failed
  logout
  token_refresh
}

// =============================================================================
// PLATFORMS
// =============================================================================
// E-commerce platforms we support (Shopify, WooCommerce, etc.)
// Using auto-increment - internal admin table, never exposed externally

model Platform {
  id        Int            @id @default(autoincrement())
  name      String         @unique @db.VarChar(100)
  status    PlatformStatus @default(ACTIVE)
  config    Json?          @db.JsonB // Platform-specific API settings
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  // Relations
  appPlatforms AppPlatform[]

  @@map("platforms")
}

// =============================================================================
// APPLICATIONS
// =============================================================================
// Our applications (SSO, Reviews, Loyalty, etc.)
// Using auto-increment - internal admin table, never exposed externally

model Application {
  id          Int               @id @default(autoincrement())
  name        String            @unique @db.VarChar(100)
  description String?           @db.Text
  iconUrl     String?           @map("icon_url") @db.VarChar(500)
  status      ApplicationStatus @default(ACTIVE)
  settings    Json?             @db.JsonB // Default app settings
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  appPlatforms AppPlatform[]

  @@map("applications")
}

// =============================================================================
// APP_PLATFORMS (Junction Table)
// =============================================================================
// Links applications to platforms they're available on
// Using auto-increment - internal reference only

model AppPlatform {
  id            Int               @id @default(autoincrement())
  applicationId Int               @map("application_id")
  platformId    Int               @map("platform_id")
  status        AppPlatformStatus @default(ACTIVE)
  config        Json?             @db.JsonB // Platform-specific app config
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  platform    Platform    @relation(fields: [platformId], references: [id], onDelete: Cascade)
  stores      Store[]
  plans       Plan[]

  @@unique([applicationId, platformId])
  @@map("app_platforms")
}

// =============================================================================
// STORES
// =============================================================================
// Merchant store installations
// KEEPING UUID - exposed in webhooks, API callbacks, external references

model Store {
  id              String      @id @default(uuid()) @db.Uuid
  appPlatformId   Int         @map("app_platform_id")
  platformStoreId String      @map("platform_store_id") @db.VarChar(100) // Shopify shop ID
  domain          String      @unique @db.VarChar(255) // store.myshopify.com
  name            String      @db.VarChar(255)
  ownerEmail      String      @map("owner_email") @db.VarChar(255)
  credentials     String      @db.Text // Encrypted JSON: access_token, multipass_secret
  isPlus          Boolean     @default(false) @map("is_plus")
  country         String?     @db.VarChar(10)
  status          StoreStatus @default(active)
  metadata        Json?       @db.JsonB // Additional store config
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  appPlatform  AppPlatform   @relation(fields: [appPlatformId], references: [id], onDelete: Cascade)
  subscription Subscription?
  ssoProviders SsoProvider[]
  ssoUsers     SsoUser[]
  loginEvents  LoginEvent[]

  @@unique([appPlatformId, platformStoreId])
  @@index([domain])
  @@index([status])
  @@map("stores")
}

// =============================================================================
// PLANS
// =============================================================================
// Subscription plans for each app-platform combination
// Using auto-increment - internal pricing table, referenced by name in UI

model Plan {
  id            Int      @id @default(autoincrement())
  appPlatformId Int      @map("app_platform_id")
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  monthlyPrice  Decimal  @default(0) @map("monthly_price") @db.Decimal(10, 2)
  annualPrice   Decimal  @default(0) @map("annual_price") @db.Decimal(10, 2)
  userLimit     Int      @default(-1) @map("user_limit") // -1 = unlimited
  features      Json?    @db.JsonB // Feature flags
  trialDays     Int      @default(0) @map("trial_days")
  isActive      Boolean  @default(true) @map("is_active")
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  appPlatform   AppPlatform    @relation(fields: [appPlatformId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@unique([appPlatformId, name])
  @@map("plans")
}

// =============================================================================
// SUBSCRIPTIONS
// =============================================================================
// Store subscription to a plan
// Using auto-increment - internal billing reference, not exposed externally

model Subscription {
  id                 Int                @id @default(autoincrement())
  storeId            String             @unique @map("store_id") @db.Uuid
  planId             Int                @map("plan_id")
  status             SubscriptionStatus @default(trialing)
  billingCycle       BillingCycle       @default(monthly) @map("billing_cycle")
  currentUserCount   Int                @default(0) @map("current_user_count")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  currentPeriodStart DateTime?          @map("current_period_start")
  currentPeriodEnd   DateTime?          @map("current_period_end")
  canceledAt         DateTime?          @map("canceled_at")
  platformChargeId   String?            @map("platform_charge_id") @db.VarChar(100) // Shopify charge ID
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  plan  Plan  @relation(fields: [planId], references: [id])

  @@index([status])
  @@map("subscriptions")
}

// =============================================================================
// SSO_PROVIDERS
// =============================================================================
// Identity providers configured per store
// KEEPING UUID - exposed in SSO redirect URLs, IdP configurations

model SsoProvider {
  id              String            @id @default(uuid()) @db.Uuid
  storeId         String            @map("store_id") @db.Uuid
  providerType    String            @map("provider_type") @db.VarChar(50) // google, okta, azure
  protocol        SsoProtocol
  displayName     String            @map("display_name") @db.VarChar(100)
  iconUrl         String?           @map("icon_url") @db.VarChar(500)
  displayOrder    Int               @default(0) @map("display_order")
  isEnabled       Boolean           @default(true) @map("is_enabled")
  isDefault       Boolean           @default(false) @map("is_default")
  buttonStyle     Json?             @map("button_style") @db.JsonB // CSS styling
  displayLocation Json?             @map("display_location") @db.JsonB // Where to show button
  config          String            @db.Text // Encrypted: client_id, client_secret, etc.
  scopeMappings   Json?             @map("scope_mappings") @db.JsonB // OIDC claim mappings
  attributeMap    Json?             @map("attribute_map") @db.JsonB // SAML attribute mappings
  status          SsoProviderStatus @default(pending_setup)
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  ssoUsers    SsoUser[]
  loginEvents LoginEvent[]

  @@index([storeId, isEnabled])
  @@index([providerType])
  @@map("sso_providers")
}

// =============================================================================
// SSO_USERS
// =============================================================================
// Users authenticated via SSO
// KEEPING UUID - stored in JWTs, external identity systems, security-sensitive

model SsoUser {
  id                 String        @id @default(uuid()) @db.Uuid
  storeId            String        @map("store_id") @db.Uuid
  ssoProviderId      String        @map("sso_provider_id") @db.Uuid
  idpCustomerId      String        @map("idp_customer_id") @db.VarChar(255) // ID from identity provider
  platformCustomerId String?       @map("platform_customer_id") @db.VarChar(100) // Shopify customer ID
  email              String        @db.VarChar(255)
  firstName          String?       @map("first_name") @db.VarChar(100)
  lastName           String?       @map("last_name") @db.VarChar(100)
  passwordHash       String?       @map("password_hash") @db.Text // For non-Plus stores
  profileData        Json?         @map("profile_data") @db.JsonB // Additional profile info
  lastLoginAt        DateTime?     @map("last_login_at")
  loginCount         Int           @default(0) @map("login_count")
  status             SsoUserStatus @default(active)
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  ssoProvider SsoProvider  @relation(fields: [ssoProviderId], references: [id], onDelete: Cascade)
  loginEvents LoginEvent[]

  @@unique([storeId, ssoProviderId, idpCustomerId])
  @@index([email])
  @@index([platformCustomerId])
  @@map("sso_users")
}

// =============================================================================
// LOGIN_EVENTS
// =============================================================================
// Audit log for all login attempts
// Using BigInt auto-increment - high volume table, internal logs only

model LoginEvent {
  id            BigInt         @id @default(autoincrement())
  storeId       String         @map("store_id") @db.Uuid
  ssoProviderId String?        @map("sso_provider_id") @db.Uuid
  ssoUserId     String?        @map("sso_user_id") @db.Uuid
  eventType     LoginEventType @map("event_type")
  ipAddress     String?        @map("ip_address") @db.VarChar(45) // IPv6 compatible
  userAgent     String?        @map("user_agent") @db.Text
  errorCode     String?        @map("error_code") @db.VarChar(50)
  metadata      Json?          @db.JsonB // Additional event data
  createdAt     DateTime       @default(now()) @map("created_at")

  // Relations
  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  ssoProvider SsoProvider? @relation(fields: [ssoProviderId], references: [id], onDelete: SetNull)
  ssoUser     SsoUser?     @relation(fields: [ssoUserId], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([eventType])
  @@index([errorCode])
  @@map("login_events")
}
